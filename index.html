<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Floor AR Example</title>
	<script src="https://cdn.jsdelivr.net/npm/@mediaman/ar.js@2.0.0-dev.4/build/marker-free/three.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@mediaman/ar.js@2.0.0-dev.4/build/marker-free/ar.js"></script>
	<style>
		#arjs-canvas {
			width: 100%;
			height: 100%;
			position: absolute;
			top: 0;
			left: 0;
			z-index: -1;
		}
	</style>
</head>
<body>
	<canvas id="arjs-canvas"></canvas>
	<script>
		const canvas = document.getElementById('arjs-canvas');

		const renderer = new THREE.WebGLRenderer({
			canvas: canvas,
			antialias: true,
			alpha: true
		});
		renderer.setClearColor(new THREE.Color('lightgrey'), 0);
		renderer.setSize(canvas.width, canvas.height);

		const scene = new THREE.Scene();

		const camera = new THREE.Camera();
		scene.add(camera);

		const light = new THREE.AmbientLight(0xffffff);
		scene.add(light);

		const controls = new THREE.DeviceOrientationControls(camera);

		// floor plane
		const floorGeometry = new THREE.PlaneBufferGeometry(20, 20);
		const floorMaterial = new THREE.MeshBasicMaterial({ color: 'gray' });
		const floor = new THREE.Mesh(floorGeometry, floorMaterial);
		floor.rotation.x = -Math.PI / 2;
		scene.add(floor);

		const arToolkitSource = new THREEx.ArToolkitSource({
			sourceType: 'webcam',
			displayWidth: 640,
			displayHeight: 480
		});

		arToolkitSource.init(() => {
			setTimeout(() => {
				onResize();
			}, 2000);
		});

		window.addEventListener('resize', onResize);

		function onResize() {
			arToolkitSource.onResizeElement();
			arToolkitSource.copyElementSizeTo(renderer.domElement);
			if (arToolkitContext.arController !== null) {
				arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
			}
		}

		const arToolkitContext = new THREEx.ArToolkitContext({
			debug: false,
			cameraParametersUrl: 'https://raw.githubusercontent.com/nicolocarpignoli/AR.js-boilerplate/master/camera_para.dat',
			detectionMode: 'mono'
		});

		arToolkitContext.init(() => {
			camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
		});

		const arMarkerControls = new THREEx.ArMarkerControls(arToolkitContext, camera, {
			type: 'pattern',
			patternUrl: 'https://raw.githubusercontent.com/nicolocarpignoli/AR.js-boilerplate/master/patterns/floor.patt',
			changeMatrixMode: 'cameraTransformMatrix'
		});

		function render() {
			requestAnimationFrame(render);
			if (arToolkitSource.ready === false) {
				return;
			}

			arToolkitContext.update(arToolkitSource.domElement);

			controls.update();

			renderer.render(scene, camera);
		}

		requestAnimationFrame(render);
	</script>
</body>
</html>
